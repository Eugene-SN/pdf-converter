# PDF Converter Pipeline - Модульная Архитектура

> Готовое решение для высококачественной конвертации **цифровых PDF** в Markdown с модульной оркестрацией, 5-уровневым контролем качества, глубокой валидацией и опциональным переводом с применением современных технологий ИИ с китайского на английский или русский языки.

## 🚀 Обзор системы

**PDF Converter Pipeline** — высокопроизводительная система, разработанная для конвертации и перевода цифровых PDF-документов, адаптированная под многоязычную локализацию. Пайплайн сочетает гибкую модульную архитектуру (4 DAG + Master Orchestrator), интеллектуальное извлечение цифрового слоя PDF (Docling), комбинированный OCR (PaddleOCR + Tesseract) для гибридных сценариев и 5-уровневую систему QA для достижения качества вплоть до 100 %.

Проект масштабируется от локального запуска через единый сценарий `translate-documents.sh`, который поддерживает режимы «только конвертация PDF→MD с 5-уровневой валидацией» и «конвертация + перевод», до распределённого исполнения в кластере Airflow с подключением vLLM для переводов на английский и русский языки.

## ⭐ Ключевые особенности

- 🧠 **vLLM Integration** — использование высокопроизводительных inference-серверов vLLM для переводов и QA-промптов (используется динамическая замена моделей для разных задач).
- 🏗️ **Модульная архитектура** — Master Orchestrator управляет четырьмя специализированными DAG: предварительная обработка, преобразование, перевод, контроль качества.
- 📄 **Docling + OCR** — гибридный стек Docling + PaddleOCR + Tesseract + Tabula-Py обеспечивает точное извлечение текста, таблиц и изображений.
- 🔍 **5-уровневая QA система** — комбинированная проверка (OCR cross-check, визуальный diff, AST-анализ, содержательная валидация, автокоррекция).
- 🌐 **Многоязычность** — китайский → английский/русский с сохранением технической терминалогии для серверного оборудования.
- 📊 **Полный мониторинг** — Prometheus + Grafana с кастомными дашбордами и alerting.
- ⚡ **GPU оптимизация** — нативная поддержка 2× NVIDIA A6000 под CUDA 12.9.

## 🏛️ Архитектура системы

```
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│ Flask API       │   │ Master DAG      │   │ Monitoring      │
│ (Gateway)       │◄─►│ (Orchestrator)  │◄─►│ Prometheus+     │
└─────────────────┘   └─────────────────┘   │ Grafana         │
              │                             └─────────────────┘
              ▼
┌─────────────────────────────────────────────────────────────┐
│ Modular DAG Pipeline                                        │
└─────────────────────────────────────────────────────────────┘
                        │
┌───────────────────────┼───────────────────────────────┐
▼                       ▼                               ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ DAG 1        │  │ DAG 2        │  │ DAG 3        │  │ DAG 4        │
│ Document     │─►│ Content      │─►│ Translation  │─►│ Quality      │
│ Preprocessing│  │Transformation│  │ Pipeline     │  │ Assurance    │
│              │  │              │  │              │  │ (5 levels)   │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘
       │                │                │                │
       ▼                ▼                ▼                ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ Docling +    │ │ vLLM         │ │ vLLM         │ │ OCR Cross-   │
│ PaddleOCR +  │ │ Qwen/Qwen3-  │ │ Qwen/Qwen3-  │ │ Validation + │
│ Tesseract +  │ │ 30B-A3B-     │ │ 30B-A3B-     │ │ Visual Diff +│
│ Tabula-Py    │ │ Instruct-2507│ │ Instruct-2507│ │ AST Compare +│
│              │ │ Markdown     │ │ Translation  │ │ Auto-Correct │
└──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
```

Master Orchestrator через Airflow координирует прохождение документов по всем этапам, собирает телеметрию и публикует события в систему мониторинга. Для локальной разработки каждый DAG может быть вызван напрямую через соответствующие скрипты репозитория.

## 🔄 Модульные DAG

### DAG 1: Document Preprocessing
- **Цель**: Чистое извлечение контента без потерь структуры.
- **Компоненты**: IBM Docling, PaddleOCR + Tesseract cross-validation, Tabula-Py для таблиц.
- **Выходы**: Структурированный контент, метаданные, промежуточные артефакты (изображения, таблицы, статистика).

### DAG 2: Content Transformation
- **Цель**: Генерация высококачественного Markdown.
- **Компоненты**: vLLM с моделью `Qwen/Qwen3-30B-A3B-Instruct-2507` (централизованно задаётся через `VLLM_MODEL_NAME`), нормализация Markdown, постобработка.
- **Выходы**: Markdown с сохранением семантики и технических терминов.

### DAG 3: Translation Pipeline
- **Цель**: Перевод с сохранением структуры и команд.
- **Компоненты**: vLLM с моделью `Qwen/Qwen3-30B-A3B-Instruct-2507` (через ту же переменную `VLLM_MODEL_NAME`), промпты для технической документации.
- **Выходы**: Переведённые Markdown-файлы (EN/RU) + сопутствующие метаданные.

### DAG 4: Quality Assurance (5 уровней)
- **Уровень 1**: OCR cross-validation (PaddleOCR + Tesseract).
- **Уровень 2**: Визуальное сравнение + SSIM-анализ.
- **Уровень 3**: AST сравнение структуры документов.
- **Уровень 4**: Валидация содержимого (таблицы, код, изображения, термины).
- **Уровень 5**: Автокоррекция, итоговая оценка (до 100 %).

### Инфраструктура и сервисы

- **`airflow/`** — DAG Master Orchestrator и специализированные DAG 1–4.
- **`flask/`** — REST API (gateway) для загрузки PDF и управления заданиями.
- **`grafana/`, `prometheus/`** — мониторинг (дашборды, алерты).
- **`vllm/`** — конфигурация inference-серверов и загрузка моделей Qwen.
- **`docs/`** — архитектурные диаграммы, deployment-guide и дополнительные схемы.

## ⚙️ Этапы обработки документа

1. **Подготовка** — PDF помещаются в каталог `input/` (используется локальным скриптом) или загружаются через Flask API.
2. **Запуск конвертации** — локально через режим «5. Только конвертация PDF → MD» скрипта `translate-documents.sh` либо Master DAG в Airflow инициируют выполнение `document_processor`.
3. **Docling-преобразование** — извлечение структуры, таблиц, изображений (без OCR по умолчанию, OCR включается опционально или при отсутствии цифрового слоя в PDF).
4. **Нормализация Markdown** — очистка форматирования, сохранение результата в подкаталог языка (`output/<язык>/`). По умолчанию локальный скрипт кладёт Markdown в `output/zh/`.
5. **Метаданные** — запись технической информации в JSON-ответ (в локальном режиме) и формирование отдельных отчётов при работе полного пайплайна.
6. **QA Pipeline** — запуск модулей `quality_assurance` для проверки целостности.
7. **Перевод (опционально)** — `translate-documents.sh` вызывает `translator` для генерации EN/RU версий с помощью vLLM.
8. **Отчётность** — результаты публикуются в Prometheus, отображаются в Grafana и доступны в Airflow UI.

> ℹ️ Локальный сценарий `translate-documents.sh` считает задачу **успешной** только при появлении итогового файла перевода в `output/<язык>/`. Если QA на этапе Stage 3 блокирует публикацию Markdown, скрипт завершится с ошибкой и предупредит об отсутствии результата.

#### Ограничения QA для перевода
- Максимальная доля китайских символов в финальном документе — **20 %** (`max_chinese_chars_ratio = 0.2`).
- Не менее **80 %** китайского текста и специализированных терминов должны быть переведены; нарушение фиксируется в отчётах QA уровня 4.

### 🌐 Настройки Translator Service
- `TRANSLATOR_URL` — базовый URL, который используется Airflow и вспомогательными скриптами для обращения к микросервису перевода. Значение по умолчанию внутри контейнеров — `http://translator:8003`.
- `SERVICE_PORT` — порт, на котором запускается FastAPI-приложение перевода. Docker-образ и исходники используют значение `8003`; при необходимости порт можно переопределить через переменную окружения перед запуском контейнера.

### Конфигурация системы
- **ОС**: Ubuntu 24.04
- **RAM**: 2 TB
- **GPU**: 2× NVIDIA A6000 (48 GB VRAM каждая)
- **CUDA**: 12.9+
- **Docker**: 24.0+
- **Docker Compose**: 2.20+

### Мониторинг обработки
- **Airflow UI** — контроль DAG и задач
- **Grafana** — визуализация KPI и QA-метрик
- **Логи** — `docker compose logs -f <service>`

## 📊 Мониторинг и метрики

**Grafana** отслеживает:
- Pipeline Success Rate
- Processing Time by DAG
- Quality Assurance Scores
- vLLM Performance (latency, throughput)
- System Resources (CPU, RAM, GPU)

**Alerts** (Prometheus/Grafana):
- Ошибки в любом DAG
- Качество ниже 95 %
- Превышение SLA по времени
- Аномалии GPU/моделей

## 📦 Deployment Notes

- Переменная окружения **`VLLM_API_KEY`** обязательна для сервисов перевода и QA. Airflow DAG `quality_assurance` теперь прерывает авто-коррекцию при отсутствии ключа или при ответе `401 Unauthorized`, поэтому перед развёртыванием убедитесь, что переменная задана в `.env`, секретах Kubernetes или другом механизме конфигурации.
- Обновлённые guardrails ускоряют диагностику ошибок — при неверном ключе задача «Auto-Correction» помечается как `failed`, что блокирует дальнейшую оркестрацию до устранения проблемы с авторизацией.

## ❗️ Зависимость Docling и предупреждение `Docling не установлен`

Функциональность Docling теперь целиком сосредоточена в сервисе `document-processor`. Flask API выступает шлюзом и пересылает загруженные PDF в `document-processor` по HTTP. Поэтому само приложение Flask не требует локальной установки [`docling`](https://pypi.org/project/docling-core/).

**Что означают предупреждения в логах Flask API:**

- Сообщение `Docling недоступен через document-processor ... - будет использован fallback режим` появляется, если Flask не может обратиться к сервису `document-processor` на `DOCUMENT_PROCESSOR_URL`.
- В таком случае включается упрощённый fallback (PyMuPDF), который предназначен только для аварийных сценариев и не заменяет полноценную Docling-конвертацию.

**Как убедиться, что Docling задействован:**

1. Проверьте, что контейнер/служба `document-processor` запущена и прошла health-check:
   ```bash
   docker compose ps document-processor
   curl http://localhost:8001/health
   ```
2. Убедитесь, что внутри контейнера `document-processor` установлены зависимости Docling (они уже прописаны в `document_processor/requirements-docprocessor.txt`). При необходимости пересоберите образ:
   ```bash
   docker compose build document-processor
   docker compose up -d document-processor
   ```
3. В логах `flask-api` после успешного соединения с `document-processor` предупреждения пропадут, а цифровые PDF будут обрабатываться Docling внутри специализированного сервиса.


## 🗂️ Структура выходных файлов

```
output/
└── <язык> (zh - для конвертации без перевода, en/ru - конвертация с переводом)/
    ├── <timestamp>_<имя_файла>.md  # Основной Markdown (по умолчанию zh)
    ├── images/                     # (опционально) вложенные изображения
    └── metadata/                   # (опционально) вспомогательные JSON/отчёты
```
