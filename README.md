# PDF Converter Pipeline - Модульная Архитектура

> Готовое решение для высококачественной конвертации **цифровых PDF** в Markdown с модульной оркестрацией, 5-уровневым контролем качества, глубокой валидацией и опциональным переводом с применением современных технологий ИИ с китайского на английский или русский языки.

## 🚀 Обзор системы

**PDF Converter Pipeline** — высокопроизводительная система, разработанная для конвертации и перевода цифровых PDF-документов, адаптированная под многоязычную локализацию. Пайплайн сочетает гибкую модульную архитектуру (4 DAG + Master Orchestrator), интеллектуальное извлечение цифрового слоя PDF (Docling), комбинированный OCR (PaddleOCR + Tesseract) для гибридных сценариев и 5-уровневую систему QA для достижения качества вплоть до 100 %.

Проект масштабируется от локального запуска через единый сценарий `translate-documents.sh`, который поддерживает режимы «только конвертация PDF→MD с 5-уровневой валидацией» и «конвертация + перевод», до распределённого исполнения в кластере Airflow с подключением vLLM для переводов на английский и русский языки.

## ⭐ Ключевые особенности

- 🧠 **vLLM Integration** — использование высокопроизводительных inference-серверов vLLM для переводов и QA-промптов (используется динамическая замена моделей для разных задач).
- 🏗️ **Модульная архитектура** — Master Orchestrator управляет четырьмя специализированными DAG: предварительная обработка, преобразование, перевод, контроль качества.
- 📄 **Docling + OCR** — гибридный стек Docling + PaddleOCR + Tesseract + Tabula-Py обеспечивает точное извлечение текста, таблиц и изображений.
- 🔍 **5-уровневая QA система** — комбинированная проверка (OCR cross-check, визуальный diff, AST-анализ, содержательная валидация, автокоррекция).
- 🌐 **Многоязычность** — китайский → английский/русский с сохранением технической терминалогии для серверного оборудования.
- 📊 **Полный мониторинг** — Prometheus + Grafana с кастомными дашбордами и alerting.
- ⚡ **GPU оптимизация** — нативная поддержка 2× NVIDIA A6000 под CUDA 12.9.

## 🏛️ Архитектура системы

```
┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
│ Flask API       │   │ Master DAG      │   │ Monitoring      │
│ (Gateway)       │◄─►│ (Orchestrator)  │◄─►│ Prometheus+     │
└─────────────────┘   └─────────────────┘   │ Grafana         │
              │                             └─────────────────┘
              ▼
┌─────────────────────────────────────────────────────────────┐
│ Modular DAG Pipeline                                        │
└─────────────────────────────────────────────────────────────┘
                        │
┌───────────────────────┼───────────────────────────────┐
▼                       ▼                               ▼
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│ DAG 1        │  │ DAG 2        │  │ DAG 3        │  │ DAG 4        │
│ Document     │─►│ Content      │─►│ Translation  │─►│ Quality      │
│ Preprocessing│  │Transformation│  │ Pipeline     │  │ Assurance    │
│              │  │              │  │              │  │ (5 levels)   │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘
       │                │                │                │
       ▼                ▼                ▼                ▼
┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
│ Docling +    │ │ vLLM         │ │ vLLM         │ │ OCR Cross-   │
│ PaddleOCR +  │ │ Qwen2.5-VL   │ │ Qwen3-30B-   │ │ Validation + │
│ Tesseract +  │ │ Markdown     │ │ A3B-Instruct │ │ Visual Diff +│
│ Tabula-Py    │ │ Generation   │ │ Translation  │ │ AST Compare +│
│              │ │              │ │              │ │ Auto-Correct │
└──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘
```

Master Orchestrator через Airflow координирует прохождение документов по всем этапам, собирает телеметрию и публикует события в систему мониторинга. Для локальной разработки каждый DAG может быть вызван напрямую через соответствующие скрипты репозитория.

## 🔄 Модульные DAG

### DAG 1: Document Preprocessing
- **Цель**: Чистое извлечение контента без потерь структуры.
- **Компоненты**: IBM Docling, PaddleOCR + Tesseract cross-validation, Tabula-Py для таблиц.
- **Выходы**: Структурированный контент, метаданные, промежуточные артефакты (изображения, таблицы, статистика).

### DAG 2: Content Transformation
- **Цель**: Генерация высококачественного Markdown.
- **Компоненты**: vLLM с Qwen2.5-VL-32B-Instruct, нормализация Markdown, постобработка.
- **Выходы**: Markdown с сохранением семантики и технических терминов.

### DAG 3: Translation Pipeline
- **Цель**: Перевод с сохранением структуры и команд.
- **Компоненты**: vLLM с Qwen3-30B-A3B-Instruct-2507, промпты для технической документации.
- **Выходы**: Переведённые Markdown-файлы (EN/RU) + сопутствующие метаданные.

### DAG 4: Quality Assurance (5 уровней)
- **Уровень 1**: OCR cross-validation (PaddleOCR + Tesseract).
- **Уровень 2**: Визуальное сравнение + SSIM-анализ.
- **Уровень 3**: AST сравнение структуры документов.
- **Уровень 4**: Валидация содержимого (таблицы, код, изображения, термины).
- **Уровень 5**: Автокоррекция, итоговая оценка (до 100 %).

### Инфраструктура и сервисы

- **`airflow/`** — DAG Master Orchestrator и специализированные DAG 1–4.
- **`flask/`** — REST API (gateway) для загрузки PDF и управления заданиями.
- **`grafana/`, `prometheus/`** — мониторинг (дашборды, алерты).
- **`vllm/`** — конфигурация inference-серверов и загрузка моделей Qwen.
- **`docs/`** — архитектурные диаграммы, deployment-guide и дополнительные схемы.

## ⚙️ Этапы обработки документа

1. **Подготовка** — PDF помещаются в каталог `input/` (используется локальным скриптом) или загружаются через Flask API.
2. **Запуск конвертации** — локально через режим «5. Только конвертация PDF → MD» скрипта `translate-documents.sh` либо Master DAG в Airflow инициируют выполнение `document_processor`.
3. **Docling-преобразование** — извлечение структуры, таблиц, изображений (без OCR по умолчанию, OCR включается опционально или при отсутствии цифрового слоя в PDF).
4. **Нормализация Markdown** — очистка форматирования, сохранение результата в подкаталог языка (`output/<язык>/`). По умолчанию локальный скрипт кладёт Markdown в `output/zh/`.
5. **Метаданные** — запись технической информации в JSON-ответ (в локальном режиме) и формирование отдельных отчётов при работе полного пайплайна.
6. **QA Pipeline** — запуск модулей `quality_assurance` для проверки целостности.
7. **Перевод (опционально)** — `translate-documents.sh` вызывает `translator` для генерации EN/RU версий с помощью vLLM.
8. **Отчётность** — результаты публикуются в Prometheus, отображаются в Grafana и доступны в Airflow UI.

### 🌐 Настройки Translator Service
- `TRANSLATOR_URL` — базовый URL, который используется Airflow и вспомогательными скриптами для обращения к микросервису перевода. Значение по умолчанию внутри контейнеров — `http://translator:8003`.
- `SERVICE_PORT` — порт, на котором запускается FastAPI-приложение перевода. Docker-образ и исходники используют значение `8003`; при необходимости порт можно переопределить через переменную окружения перед запуском контейнера.

### Конфигурация системы
- **ОС**: Ubuntu 24.04
- **RAM**: 2 TB
- **GPU**: 2× NVIDIA A6000 (48 GB VRAM каждая)
- **CUDA**: 12.9+
- **Docker**: 24.0+
- **Docker Compose**: 2.20+

### Мониторинг обработки
- **Airflow UI** — контроль DAG и задач
- **Grafana** — визуализация KPI и QA-метрик
- **Логи** — `docker compose logs -f <service>`

## 📊 Мониторинг и метрики

**Grafana** отслеживает:
- Pipeline Success Rate
- Processing Time by DAG
- Quality Assurance Scores
- vLLM Performance (latency, throughput)
- System Resources (CPU, RAM, GPU)

**Alerts** (Prometheus/Grafana):
- Ошибки в любом DAG
- Качество ниже 95 %
- Превышение SLA по времени
- Аномалии GPU/моделей


## 🗂️ Структура выходных файлов

```
output/
└── <язык> (zh - для конвертации без перевода, en/ru - конвертация с переводом)/
    ├── <timestamp>_<имя_файла>.md  # Основной Markdown (по умолчанию zh)
    ├── images/                     # (опционально) вложенные изображения
    └── metadata/                   # (опционально) вспомогательные JSON/отчёты
```
